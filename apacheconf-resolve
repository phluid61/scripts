#!/usr/bin/env ruby
# vim: ts=2:sts=2:sw=2

class Proc
	alias :<< :[]
end

if RUBY_VERSION.to_f < 1.9
	class << File
		alias :absolute_path :expand_path
	end
end

def is? o
	o && !o.empty?
end

$nesting = '    '
$server_root = nil
$show_includes = is?(ENV['QUIET']) ? false : true

def indent line, base, extra=0
	if extra && extra > 0
		base += ($nesting * extra)
	end
	"#{base}#{line}"
end

def parse_apacheconf str, fn, depth='', &block
	min_depth = 0
	local_depth = 0
	obj = ( block || [] )
	if $show_includes
		min_depth = 1
		local_depth = 1
		obj << indent("\#\# #{fn}", depth)
		obj << indent('#{', depth)
	end
	str.each_line do |line|
		line.gsub!(/#.*$/,'')
		line.strip!
		line.gsub!(/\s+/,' ')
		case line
		when ''
			# ignore blank line
		when /^Include(?:Optional)? (\S+)$/
			fn = $1
			if $show_includes
				obj << indent("\##{line}", depth, local_depth)
				obj << indent("\#{", depth, local_depth)
				parse_apacheconf_file fn, indent($nesting,depth,local_depth), &block
				obj << indent("\#}", depth, local_depth)
			else
				parse_apacheconf_file fn, indent('',depth,local_depth), &block
			end
		when %r(<[^/])
			obj << indent(line, depth, local_depth)
			local_depth += 1
		when %r(</)
			local_depth -= 1
			local_depth = min_depth if local_depth < min_depth
			obj << indent(line, depth, local_depth)
		when /ServerRoot (\S+)$/
			# FIXME: this should probably apply before any Includes
			$server_root = $1.gsub('"','')
			obj << indent(line, depth, local_depth)
		else
			obj << indent(line, depth, local_depth)
		end
	end
	if $show_includes
		obj << indent('#}', depth)
	end
	block_given? ? nil : obj
end

def parse_apacheconf_file fn, depth='', &block
	fn += '*' if fn.end_with? '/'
	fn = File.absolute_path(fn, $server_root)
	if fn['*']
		Dir[fn].sort.each do |realfn|
			parse_apacheconf( File.open(realfn) {|fh| fh.read }, realfn, depth, &block )
		end
	else
		parse_apacheconf( File.open(fn) {|fh| fh.read }, fn, depth, &block )
	end
end

if ARGV.empty?
	possible_files = %w(
		/etc/apache2/apache2.conf
		/etc/httpd/conf/httpd.conf
	)
	$root_file = possible_files.find { |fn| File.exist? fn }
	raise 'No Apache httpd config file given' if !$root_file
else
	$root_file = File.absolute_path(ARGV.first)
end
$server_root = File.dirname($root_file)

parse_apacheconf_file $root_file do |line|
	puts line
end

__END__

=head1 NAME

apacheconf-resolve - apache config resolver

=head1 SYNOPSIS

B<apacheconf-resolve> [I<filename>]

=head1 DESCRIPTION

Loads and minimally parses your apache conf. Reformats whitespace,
strips all comments and blank lines, and dereferences all C<Include>
directives.

If I<filename> is omitted, defaults to C</etc/apache2/apache2.conf>
or C</etc/httpd/conf/httpd.conf> if either of those files exist.

If the environment variable C<QUIET> is non-empty, doesn't add
comments for included files.

=cut

